## GORM和Gentool介绍

### GORM简介
GORM是Go语言中最流行的ORM（对象关系映射）库之一，提供友好的API来操作数据库，支持多种数据库如MySQL、PostgreSQL、SQLite等。简化数据库操作，让开发者能用面向对象的方式处理数据。

### Gentool简介
Gentool是GORM官方提供的代码生成工具，它可以根据数据库表结构自动生成对应的Go模型结构体和安全的CRUD操作方法。解决GORM中手动编写模型和查询代码的繁琐问题，同时通过类型安全避免了SQL注入风险。

## Gentool安装

> 使用windows的同学，需要使用wsl（自行百度）
>
> 进入到ubuntu，安装golang的环境，参考10小时入门Go语言的第一节课

### 安装命令
```bash
go install gorm.io/gen/tools/gentool@latest
```

验证安装：
```bash
gentool -h
```

## Gentool配置和使用

### 命令行方式
最基本的用法是通过命令行参数直接指定连接信息：

```bash
gentool -dsn "user:password@tcp(localhost:3306)/database?charset=utf8mb4&parseTime=True&loc=Local" -tables "table1,table2" -outPath "./dao/query"
```

### 配置文件方式
对于更复杂的项目，建议使用配置文件方式。创建`gen.yaml`文件：

```yaml
version: "0.1"
database:
  dsn: "root:123456@tcp(127.0.0.1:3306)/test_db?charset=utf8mb4&parseTime=true&loc=Local"
  db: "mysql"
  # 指定生成的查询代码文件的输出目录
  outPath: "./query"
  # 指定查询代码的主文件名 gen.go
  outFile: ""
  # 是否为查询代码生成单元测试
  withUnitTest: false
  # 指定生成的模型代码的包名
  modelPkgName: "model"
  # 当字段可为空时是否生成指针类型
  fieldNullable: true
  # 是否为字段生成GORM索引标签,在GORM标签中包含索引信息，如gorm:"index"
  fieldWithIndexTag: false
  # 是否为字段生成GORM列类型标签,在GORM标签中包含完整的列类型信息
  fieldWithTypeTag: false
```

然后使用配置文件生成代码：
```bash
gentool -c "./gen.yaml"
```

## 完整示例

### 数据库表结构
假设我们有一个`users`表：
```sql
CREATE TABLE `users` (
    `id` BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(64) NOT NULL DEFAULT '',
    `email` VARCHAR(255) NOT NULL DEFAULT '',
    `age` INT NOT NULL DEFAULT '0',
    `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户表';
```

Makefile，方便后续使用

```makefile
TOPDIR=$(shell pwd)

all: gendb
	@echo "ALL DONE"

gendb:
	@echo "start gen db model...."$(TOPDIR)
	@cd $(TOPDIR) && gentool -c gen.yml

```



### 项目结构
生成后的项目结构如下：
```
3-6/
├── main.go
|—— Makefile
|-- gen.yaml
├── go.mod
|—— query/
│      ├── gen.go
│      └── users.gen.go
└── model/
    └── users.gen.go
```

### 操作数据的示例代码

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"

    "gorm.io/driver/mysql"
    "gorm.io/gorm"

    "your-project/dao/query"
    "your-project/model"
)

func main() {
    // 初始化数据库连接
    dsn := "root:123456@tcp(127.0.0.1:3306)/test_db?charset=utf8mb4&parseTime=True&loc=Local"
    db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
    if err != nil {
        log.Fatal("数据库连接失败:", err)
    }

    // 设置查询实例
    q := query.Use(db)
    ctx := context.Background()
    userDAO := q.User

    // 1. 创建用户
    newUser := model.User{
        Name:  "张三",
        Email: "zhangsan@example.com",
        Age:   25,
    }
    
    err = userDAO.WithContext(ctx).Create(&newUser)
    if err != nil {
        log.Fatal("创建用户失败:", err)
    }
    fmt.Printf("创建用户成功，ID: %d\n", newUser.ID)

    // 2. 查询用户
    // 根据ID查询
    user, err := userDAO.WithContext(ctx).Where(q.User.ID.Eq(newUser.ID)).First()
    if err != nil {
        log.Fatal("查询用户失败:", err)
    }
    fmt.Printf("查询结果: %+v\n", user)

    // 条件查询
    users, err := userDAO.WithContext(ctx).
        Where(q.User.Age.Gte(20), q.User.Name.Like("%张%")).
        Find()
    if err != nil {
        log.Fatal("条件查询失败:", err)
    }
    fmt.Printf("找到 %d 个用户\n", len(users))

    // 3. 更新用户
    _, err = userDAO.WithContext(ctx).
        Where(q.User.ID.Eq(newUser.ID)).
        Update(q.User.Age, 26)
    if err != nil {
        log.Fatal("更新用户失败:", err)
    }
    fmt.Println("更新用户年龄成功")

    // 多字段更新
    _, err = userDAO.WithContext(ctx).
        Where(q.User.ID.Eq(newUser.ID)).
        Updates(model.User{
            Name: "张三丰",
            Age:  27,
        })
    if err != nil {
        log.Fatal("多字段更新失败:", err)
    }

    // 4. 删除用户
    _, err = userDAO.WithContext(ctx).
        Where(q.User.ID.Eq(newUser.ID)).
        Delete()
    if err != nil {
        log.Fatal("删除用户失败:", err)
    }
    fmt.Println("删除用户成功")

    // 5. 事务操作
    err = q.Transaction(func(tx *query.Query) error {
        userTx := tx.User
        
        // 在事务中创建用户
        user1 := model.User{Name: "用户1", Email: "user1@example.com", Age: 30}
        if err := userTx.WithContext(ctx).Create(&user1); err != nil {
            return err
        }

        // 创建另一个用户
        user2 := model.User{Name: "用户2", Email: "user2@example.com", Age: 28}
        if err := userTx.WithContext(ctx).Create(&user2); err != nil {
            return err
        }

        fmt.Println("事务执行成功")
        return nil
    })

    if err != nil {
        log.Fatal("事务执行失败:", err)
    }
}
```

## 总结

通过这节课，应该已经掌握：

1. **Gentool的基本概念**和安装方法
2. **配置和使用Gentool**生成模型和查询代码
3. **使用生成的代码**进行CRUD操作和事务处理

记得在实际项目中根据具体需求调整生成配置，并合理组织生成的代码结构。