# HTTP编程（net/http包、创建HTTP服务器、处理请求与响应）

## 1. HTTP协议基础理论

### 什么是HTTP？
HTTP（HyperText Transfer Protocol，超文本传输协议）是互联网上应用最为广泛的一种网络协议，用于客户端和服务器之间的通信。

**核心特点：**
- **无状态协议**：每次请求都是独立的，服务器不保留之前请求的信息
- **基于请求-响应模型**：客户端发起请求，服务器返回响应
- **应用层协议**：建立在TCP/IP协议之上
- **明文传输**：数据不加密（HTTPS是加密版本）

### HTTP请求-响应流程

```
客户端 (浏览器/APP)       服务器 (Web服务)
     |                         |
     | --- HTTP请求  ------->  |
     |                         | 
     | <--- HTTP响应 --------  |
     |                         |
```

### HTTP请求组成
```
GET /api/students HTTP/1.1          ← 请求行（方法 + URL + 协议版本）
Host: localhost:8080                ← 请求头（元数据）
Content-Type: application/json
Authorization: Bearer token123
                                   ← 空行分隔
{"name": "张三", "age": 20}         ← 请求体（可选，POST/PUT时有）
```

**HTTP方法语义：**
- `GET`：获取资源（查）
- `POST`：创建资源（增）
- `PUT`：更新资源（改）
- `DELETE`：删除资源（删）
- `PATCH`：部分更新

### HTTP响应组成
```
HTTP/1.1 200 OK                     ← 状态行（协议版本 + 状态码 + 描述）
Content-Type: application/json      ← 响应头（元数据）
Content-Length: 45
Date: Mon, 23 Oct 2023 08:00:00 GMT
                                   ← 空行分隔
{"id": 1, "name": "张三", "age": 20} ← 响应体（数据内容）
```

**常见状态码：**
- `200 OK`：请求成功
- `201 Created`：资源创建成功
- `400 Bad Request`：客户端请求错误
- `401 Unauthorized`：未认证
- `404 Not Found`：资源不存在
- `500 Internal Server Error`：服务器内部错误

## 2. Go语言中的HTTP编程模型

### net/http包架构

```
客户端请求
    ↓
http.ServeMux (路由 multiplexer) 
    ↓
http.Handler (处理器接口)
    ↓  
具体处理逻辑 (HandlerFunc或自定义Handler)
    ↓
http.ResponseWriter (写回响应)
```

### 核心组件说明

**1. 路由 (ServeMux)**
- 负责将不同的URL路径映射到对应的处理器
- 可以创建多个路由，但通常一个应用使用一个主路由

**2. 处理器 (Handler)**
```go
// Handler是一个接口，只需要实现一个方法
type Handler interface {
    ServeHTTP(ResponseWriter, *Request)
}
```

**3. 处理器函数 (HandlerFunc)**
```go
// 函数签名，与ServeHTTP方法相同
type HandlerFunc func(ResponseWriter, *Request)
```

**4. 请求对象 (Request)**
- 包含客户端的全部请求信息
- 方法、URL、请求头、请求体等

**5. 响应写入器 (ResponseWriter)**
- 用于构建和发送响应回客户端
- 可以设置状态码、响应头、写入响应体

## 3. 创建HTTP服务器的基本流程

### 标准开发步骤

**步骤1：设计API端点**
```
GET    /students                 # 获取所有学生
POST   /students    body=json    # 创建新学生   
GET    /students?id=1            # 获取特定学生
PUT    /students    body=json    # 更新学生信息
DELETE /students    body=json    # 删除学生
```

**步骤2：定义处理器函数**
```go
func getStudents(w http.ResponseWriter, r *http.Request) {
    // 处理GET /students 请求
}

func createStudent(w http.ResponseWriter, r *http.Request) {
    // 处理POST /students 请求
}
```

**步骤3：注册路由**
```go
mux := http.NewServeMux()
mux.HandleFunc("/students", studentsHandler)      // 处理/students路径
```

**步骤4：启动服务器**

```go
// 监听8080端口，使用自定义路由
http.ListenAndServe(":8080", mux)
```

### 完整工作流程示例

```go
package main

import (
    "fmt"
    "net/http"
)

// 处理器函数：处理健康检查
func healthHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    fmt.Fprintf(w, `{"status": "healthy", "service": "student-api"}`)
}

func getStudentsHandler(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")
	if r.Method == http.MethodGet {
		fmt.Fprintf(w, `[{"id": 1, "name": "张三", "age": 20}]`)
		 return
    }
	http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)
}

func main() {
    // 创建路由
    mux := http.NewServeMux()
    
    // 注册路由路径和对应的处理器函数
    mux.HandleFunc("/students", getStudentsHandler)
    mux.HandleFunc("/health", healthHandler)
    
    // 启动服务器
    fmt.Println("服务器启动在 http://localhost:8080")
    fmt.Println("健康检查: http://localhost:8080/health")
    
    err := http.ListenAndServe(":8080", mux)
    if err != nil {
        fmt.Printf("服务器启动失败: %v\n", err)
    }
}
```

## 4.中间件模式

中间件是在请求到达具体处理器之前或之后执行的一些通用逻辑：

```go
// 日志中间件
func loggingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        log.Printf("收到请求: %s %s", r.Method, r.URL.Path)
        next.ServeHTTP(w, r)  // 调用下一个处理器
    })
}

// 使用中间件
handler := loggingMiddleware(mux)
http.ListenAndServe(":8080", handler)
```

## 5. 课时总结

### 核心概念
- **HTTP协议**：客户端-服务器通信的基础
- **请求-响应模型**：每次交互都是独立的
- **RESTful设计**：使用URL表示资源，HTTP方法表示操作

### Go语言实现
- **net/http包**：Go标准库中的HTTP实现
- **路由注册**：将URL路径映射到处理器函数
- **请求处理**：读取方法、头、体等信息
- **响应构建**：设置状态码、头、返回数据

