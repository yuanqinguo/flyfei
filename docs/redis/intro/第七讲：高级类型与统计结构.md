# 第7讲：高级类型与统计结构

# 一、课时目标

完成本节后可以：

* 理解 Bitmap 位图结构
* 理解 HyperLogLog 基数统计原理
* 掌握 用户签到系统设计
* 掌握 DAU 统计系统设计
* 理解 Redis 特殊结构的降本增效价值

---

# 二、本节结构定位

本节不是：
```
通用数据结构课
```

本节是：

```
统计型结构工具箱
```

解决问题：

```
超大规模用户统计
极低内存业务模型
```

---

# 三、Bitmap 位图结构

---

## 3.1 Bitmap本质

Redis Bitmap：

```
基于String的bit操作
```

本质：

```
bit数组
```

示例：

```
10100100101
```

---

## 3.2 为什么Bitmap极其重要

优势：

```
极低内存
高速统计
```

示例：

```
1000万用户签到
Bitmap ≈ 1.2MB
Set ≈ 几百MB
```

---

## 3.3 核心命令

设置状态：

```bash
SETBIT sign:20240201 1001 1
```

查询状态：

```bash
GETBIT sign:20240201 1001
```

统计数量：

```bash
BITCOUNT sign:20240201
```

---

## 3.4 复杂度

```
SETBIT O(1)
GETBIT O(1)
BITCOUNT O(n)
```

---

# 四、实战：用户签到系统（本节核心）

---

## 4.1 Key设计

```
sign:{date}
```

示例：

```
sign:20240201
```

---

## 4.2 Go实现签到

```go
func Sign(ctx context.Context, rdb *redis.Client, uid int64, date string) error {
	key := "sign:" + date

	return rdb.SetBit(ctx, key, uid, 1).Err()
}
```

---

## 4.3 Go实现是否签到

```go
func IsSign(ctx context.Context, rdb *redis.Client, uid int64, date string) (int64, error) {
	key := "sign:" + date

	return rdb.GetBit(ctx, key, uid).Result()
}
```

---

## 4.4 Go实现签到人数

```go
func CountSign(ctx context.Context, rdb *redis.Client, date string) (int64, error) {
	key := "sign:" + date

	return rdb.BitCount(ctx, key, nil).Result()
}
```

---

# 五、HyperLogLog（基数统计神器）

---

## 5.1 解决什么问题

```
统计独立访问用户数（UV）
```

特点：

```
极低内存
自动去重
允许误差
```

误差范围：

```
约0.81%
```

---

## 5.2 内存优势

```
Set统计1000万用户 ≈ 几百MB
HyperLogLog ≈ 12KB
```

---

## 5.3 核心命令

添加用户：

```bash
PFADD dau:20240201 user1
```

统计人数：

```bash
PFCOUNT dau:20240201
```

合并统计：

```bash
PFMERGE dau:week dau:1 dau:2
```

---

# 六、实战：DAU统计系统

---

## 6.1 Key设计

```
dau:{date}
```

---

## 6.2 Go实现记录访问

```go
func AddDAU(ctx context.Context, rdb *redis.Client, uid string, date string) error {
	key := "dau:" + date

	return rdb.PFAdd(ctx, key, uid).Err()
}
```

---

## 6.3 Go实现统计DAU

```go
func CountDAU(ctx context.Context, rdb *redis.Client, date string) (int64, error) {
	key := "dau:" + date

	return rdb.PFCount(ctx, key).Result()
}
```

---

# 七、Bitmap vs HyperLogLog

| 结构          | 特点     |
| ----------- | ------ |
| Bitmap      | 精确状态   |
| HyperLogLog | 近似统计   |
| Bitmap      | 可查询单用户 |
| HyperLogLog | 不可查询个体 |

---

# 八、工程注意事项（真实生产经验）

---

## Bitmap必须使用连续ID

否则：

```
内存爆炸
```

---

## 不要用HyperLogLog做精确业务

```
订单数
余额
库存
```

---

## Bitmap不要用于复杂关系

```
只适合布尔状态
```

---

# 九、本节课堂任务

必须完成：

1. CLI实现签到
2. CLI统计签到人数
3. CLI实现DAU统计
4. 编写签到函数
5. 编写DAU统计函数
6. 完成签到 + DAU系统

---

# 十、本节总结

你已经掌握：

* Bitmap位图模型
* HyperLogLog基数统计
* 用户签到系统设计
* DAU统计系统设计
* 统计类结构降本思维

---

# 下节课

第8讲：

* Redis的Stream
* Stream VS 消息队列